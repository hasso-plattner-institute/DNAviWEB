<!doctype html>
<html lang="en">
  <style>
    input[type=button], input[type=submit], input[type=reset] {
      background-color:forestgreen;
      border: none;
      color: white;
      padding: 16px 32px;
      text-decoration: none;
      margin: 4px 2px;
      cursor: pointer;
    }
    .radio-group input[type="radio"]:after {
      display: inline-block;
      margin-right: 20px;
      appearance: none;
        border: none;
        appearance: none;
        background-color: rgba(255,252,229,1);

    }
    .radio-group label{
      display: inline-block;
      margin-right: 10px;
    }
    input::placeholder,
    textarea::placeholder {
      color: #c0c0c0 !important;
    }
  </style>
  <!--begin::Head-->
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>DNAvi | New Analysis</title>

    <!--begin::Accessibility Meta Tags-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#007bff" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
    <!--end::Accessibility Meta Tags-->

    <!--begin::Primary Meta Tags-->
    <meta name="title" content="DNAvi | New Analysis" />
    <meta name="author" content="ColorlibHQ" />
    <meta
      name="description"
      content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS. Fully accessible with WCAG 2.1 AA compliance."
    />
    <meta
      name="keywords"
      content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard, accessible admin panel, WCAG compliant"
    />
    <!--end::Primary Meta Tags-->

    <!--begin::Accessibility Features-->
    <!-- Skip links will be dynamically added by accessibility.js -->
    <meta name="supported-color-schemes" content="light dark" />
    <link rel="preload" href="{{ url_for('static', filename='css/adminlte.css') }}" as="style" />
    <!--end::Accessibility Features-->

    <!--begin::Fonts-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
      integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
      crossorigin="anonymous"
      media="print"
      onload="this.media='all'"
    />
    <!--end::Fonts-->

    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"
      crossorigin="anonymous"
    />
    <!--end::Third Party Plugin(OverlayScrollbars)-->

    <!--begin::Third Party Plugin(Bootstrap Icons)-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
      crossorigin="anonymous"
    />
    <!--end::Third Party Plugin(Bootstrap Icons)-->

    <!--begin::Required Plugin(AdminLTE)-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/adminlte.css') }}" />
    <!--end::Required Plugin(AdminLTE)-->

    <!-- apexcharts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
      integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0="
      crossorigin="anonymous"
    />
  </head>
  <!--begin::Body-->
  <body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
      <!--begin::Header-->
      <nav class="app-header navbar navbar-expand bg-body">
        <!--begin::Container-->
        <div class="container-fluid">
          <!--begin::Start Navbar Links-->
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                <i class="bi bi-list"></i>
              </a>
            </li>
            <li class="nav-item"><a class="nav-link active" href="{{ url_for('home') }}">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('citation') }}">About</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('documentation') }}">Documentation</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('contact') }}">Contact</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('legal_notice') }}">Impressum | Legal notice</a></li>
          </ul>
          <!--end::Start Navbar Links-->

          <!--begin::End Navbar Links-->
          <ul class="navbar-nav ms-auto">
            <!--begin::Navbar Login/logout-->
            <li class="nav-item">
              {% if current_user.is_authenticated %}
                <li class="nav-item">
                  <span class="nav-link">Hello, {{ current_user.id }}</span>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                </li>
              {% else %}
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('login') }}">Login</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('register') }}">Register</a>
                </li>
              {% endif %}
            </li>
            <!--end::Navbar Login/logout-->
            <!--begin::Fullscreen Toggle-->
            <li class="nav-item">
              <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
              </a>
            </li>
            <!--end::Fullscreen Toggle-->
          </ul>
          <!--end::End Navbar Links-->
        </div>
        <!--end::Container-->
      </nav>
      <!--end::Header-->
      <!--begin::Sidebar-->
      <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <!--begin::Sidebar Brand-->
        <div class="sidebar-brand">
          <!--begin::Brand Link-->
          <a class="d-flex align-items-center" style="text-decoration: none;">
            <!--begin::Brand Image-->
            <img
              src="{{ url_for('static', filename='img/logo.svg') }}"
              alt="DNAvi Logo"
              class="brand-image opacity-75 shadow me-2"
              style="height: 60px; width: auto;"
            />
            <!--end::Brand Image-->
            <!--begin::Brand Text-->
            <span class="brand-text fw-light">DNAvi</span>
            <!--end::Brand Text-->
          </a>
          <!--end::Brand Link-->
        </div>
        <!--end::Sidebar Brand-->
        <!--begin::Sidebar Wrapper-->
        <div class="sidebar-wrapper">
          <nav class="mt-2">
            <!--begin::Sidebar Menu-->
            <ul
              class="nav sidebar-menu flex-column"
              data-lte-toggle="treeview"
              role="navigation"
              aria-label="Main navigation"
              data-accordion="false"
              id="navigation"
            >
              <li class="nav-item">
                <a href="{{ url_for('submissions_dashboard') }}" class="nav-link">
                  <i class="bi bi-grid"></i>
                  <p>Submissions Dashboard</p>
                </a>
              </li>

              <li class="nav-item">
                 <a href="{{ url_for('instructions') }}" class="nav-link">
                  <i class="bi bi-graph-up"></i>
                  <p>
                    New Analysis
                  </p>
                </a>
              </li>
              <li class="nav-item"><a href="{{ url_for('documentation') }}" class="nav-link"><i class="bi bi-file-earmark-text"></i><p>Documentation</p></a></li>
            <!--end::Sidebar Menu-->
          </nav>
        </div>
        <!--end::Sidebar Wrapper-->
      </aside>
      <!--end::Sidebar-->
      <!--begin::App Main-->
      <main class="app-main">
        <!--begin::App Content Header-->
        <div class="app-content-header">
          <!--begin::Progression Tab -->
          <div class="container my-4">
            <div class="progress" style="height: 40px;">
              <div class="progress-bar progress-bar-animated bg-secondary" role="progressbar" style="font-size: 1rem; width:34%">
                <a href="{{ url_for('instructions') }}" class="btn btn-outline-secondary" style="color:white ">1. Quickstart Guide</a>
              </div>
              <div class="progress-bar progress-bar-animated bg-primary" role="progressbar" style="font-size: 1rem; width:33%">
                2. Upload Files
              </div>
              <div class="progress-bar progress-bar-animated bg-secondary" role="progressbar" style="font-size: 1rem; width:33%">
                3. Results
              </div>
            </div>
          </div>
          <!--end::Progression Tab -->
        </div>
        <!--end::App Content Header-->
        <div class="app-content">
          <main id="content-box" class="order-first">
            <section class="work-section section" id="section-2">
              <div class="container"
                <!-- ------------------------------------------------------------------------------ -->
                <!-- DISPLAY ERRORS HERE ON TOP -->
                <!-- ------------------------------------------------------------------------------ -->
                <style> .error {background-color: #ea7f81 !important; display: inline-block}</style>
                <div class="flash-container">
                  {% with messages = get_flashed_messages() %}
                    {% if messages %}
                      <ul class="flashes">
                        {% for message in messages %}
                        <li>{{ message }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  {% endwith %}
                </div>
                <!-- ------------------------------------------------------------------------------ -->
                <!-- FILE MISSING-->
                <!-- ------------------------------------------------------------------------------ -->
                {% if missing_error %}
                  <p class=error><strong>Error:</strong> {{ missing_error }} </p>
                {% endif %}
                <!-- ------------------------------------------------------------------------------ -->
                <!-- OTHER ERROR-->
                <!-- ------------------------------------------------------------------------------ -->
                {% if error %}
                  <pre class="error"><strong>Error message from DNAvi: </strong>{{ error }}</pre>
                  <p>
                    <strong>Note: This is the end of your error message. Please read it carefully, check out our
                        <a href="{{ url_for('instructions') }}">quickstart guide</a> or
                        <a href="{{ url_for('documentation') }}">documentation</a>,
                        and try again.
                        If this doesn't solve your issues, contact us with this error message copied,
                        the date of your submission, and the submission ID (see dashboard) under dnavi-info@hpi.de.
                        <br>
                    </strong>
                  </p>
                {% endif %}
                <!-- ---------------------------------------------------------------------------------------- -->
                <!-- EXAMPLE FORM -->
                <!-- ---------------------------------------------------------------------------------------- -->
                <br>
                <form id="example-form" method="POST" enctype="multipart/form-data">
                  <button type="button" id="load-example"  style="background-color: #218838; color: white; border-radius: 0.25rem; padding: 0.75rem 1.5rem; border: none; font-size: 1rem; class="btn btn-success">
                    Quick test: Run DNAvi with our example data
                  </button>
                  <a href="./static/tests/electropherogram.csv" style="color:#b5b9bd;">
                    Download examples: Signal Table ↓
                  </a> 
                  <a href="./static/tests/ladder.csv" style="color:#b5b9bd;">
                    Size Standard ↓
                  </a>
                  <a href="./static/tests/metadata.csv" style="color:#b5b9bd;">
                    Metadata ↓
                  </a>
                  <p></p><p></p><br>
                </form>
              </div>
            <section class="work-section section" id="section-2">
              <form id="upload-form" method="POST" enctype="multipart/form-data">
                <div class="container">
                  <h3> Upload your own data:</h3>
                  <!-- ------------------------------------------------------------------------------ -->
                  <!--                                DNA GEL OR CSV                                  -->
                  <!-- ------------------------------------------------------------------------------ -->
                  <div class="card mb-4 shadow-sm">
                    <div class="card-header d-flex align-items-center" style="background-color: #eff6f8;">
                      <h5 class="mb-0 fw-normal text-dark">Step 1: Upload Gel Electrophoresis Image or Signal Table</h5>
                      <img src="./static/img/all_input_descr.svg" alt="DNA Table or Gel" style="width:15%; height:auto;">
                    </div>
                    <div class="card-body">
                      <p class="text-muted mb-2">Accepted formats: CSV, PNG, JPG, JPEG.</p>
                      <p class="text-muted mb-2">Max. 16 MB file size allowed.</p>
                      <input type="file" name="data_file" accept=".csv,.png,.jpg,.jpeg" class="form-control form-control border rounded" required>
                    </div>
                  </div>
                  <br></br>
                  <!-- ------------------------------------------------------------------------------ -->
                  <!--                        DNA SIZE STANDARD ANNOTATION CSV                        -->
                  <!-- ------------------------------------------------------------------------------ -->
                  <div class="card mb-4 shadow-sm">
                    <div class="card-header d-flex align-items-center" style="background-color: #eff6f8;">
                      <h5 class="mb-0 fw-normal text-dark">Step 2: Annotated the DNA marker</h5>
                      <img src="./static/img/annotate.svg" alt="Annotate Standard" style="width:15%; height:auto;">
                    </div>
                    <div class="card-body">
                      <!-- The radio buttons -->
                      <p>Select from defaults:</p>
                      <div class="radio-group"> 
                        <input type="radio" class="predef" name="ladder_file" value="D1000" checked ><label for="defaultOption">D1000 <a href="./static/ladders/D1000.csv" style="color:#b5b9bd;">↓</a></label>
                        <input type="radio" class="predef" name="ladder_file" value="HSD5000"><label>HSD5000 <a href="./static/ladders/HSD5000.csv" style="color:#b5b9bd;">↓</a></label>
                        <input type="radio" class="predef" name="ladder_file" value="gDNA"><label>gDNA <a href="./static/ladders/gDNA.csv" style="color:#b5b9bd;">↓</a></label>
                        <input type="radio" class="predef" name="ladder_file" value="cfDNA"><label>cfDNA <a href="./static/ladders/cfDNA.csv" style="color:#b5b9bd;">↓</a></label>
                        <input type="radio" class="predef" name="ladder_file" value="D1000B"><label>D1000 (Bioanalyzer) <a href="./static/ladders/D1000B.csv" style="color:#b5b9bd;">↓</a></label>
                        <input type="radio" class="predef" name="ladder_file" value="D7500"><label>D7500 (Bioanalyzer) <a href="./static/ladders/D7500.csv" style="color:#b5b9bd;">↓</a></label>
                        <input type="radio" class="predef" name="ladder_file" value="HSDNA"><label>HSDNA (Bioanalyzer) <a href="./static/ladders/HSDNAB.csv" style="color:#b5b9bd;">↓</a></label>
                        <input type="radio" id="uploadOption" name="ladder_file" value="upload" accept=".csv"><label for="uploadOption"> Custom </label>
                      </div>
                      <!-- The file browse input, initially shown -->
                      <div id="fileUploadContainer" style="display: none;" ><input type="file" id="myFile" name="ladder_file">
                        <a href="./static/tests/ladder.csv" style="color:#b5b9bd;">↓ Download template</a>
                      </div>
                      <!-- The script to hide the file browse -->
                      <script>
                        // Get references to the radio buttons and the file upload container
                        const uploadRadio = document.getElementById('uploadOption');
                        const defaultRadios = document.getElementsByClassName('predef');
                        const fileContainer = document.getElementById('fileUploadContainer');
                        // Listen for clicks on the radio buttons
                        uploadRadio.addEventListener('change', () => {
                          if (uploadRadio.checked) {
                            fileContainer.style.display = 'block'; // Show the file input
                          }
                        });
                        // Hide file input when any "predef" option is selected
                        Array.from(defaultRadios).forEach(radio => {
                          radio.addEventListener('change', () => {
                            if (radio.checked) {
                              fileContainer.style.display = 'none';
                            }
                          });
                        });
                      </script>
                    </div>
                  </div>
                  <br></br>
                  <!-- ------------------------------------------------------------------------------ -->
                  <!-- METADATA -->
                  <!-- ------------------------------------------------------------------------------ -->
                  <!--begin::metadata-->
                  <div class="card mb-4 shadow-sm">
                    <div class="card-header d-flex align-items-center" style="background-color: #eff6f8;">
                      <h5 class="mb-0 fw-normal text-dark">Step 3: Add Patient Metadata</h5>
                      <img src="./static/img/metadata.svg" alt="Metadata CSV" style="width:15%; height:auto;">
                    </div>
                    <div class="card-body">
                      <!--begin::metadata two options header-->
                      <p>You can skip this section if you do not have metadata, DNAvi will still perform the analysis.</p>
                      
                      <h6 class="fw-semibold text-primary mb-2" style="color: #357ABD;">Two Ways to Add Metadata</h6>
                      <ul class="mb-3 ps-3">
                        <li>Fill out the metadata table for all your samples directly on this page.</li>
                        <li>Or, download our template metadata file, after filling it, upload it here.</li>
                      </ul>
                      <!--end::metadata two options header-->

                      <!--begin::Option 1 - Online Table-->
                      <div class="p-3 mb-3" 
                            style="background-color: #EAF6FE; border-left: 4px solid #4FA8E5; border-radius: 0.75rem;">
                        <div class="d-flex align-items-center mb-2">
                          <i class="bi bi-table text-primary me-2" style="font-size: 1.2rem;"></i>
                          <h6 class="fw-semibold mb-0" style="color: #2C5282;">Option 1: Fill Out Metadata Online</h6>
                        </div>
                        <p class="mb-2">
                          Fill out the table below for all your samples directly on this page, then click "Confirm Table".  
                          <hr class="my-3" style="border-top: 1px dashed #D6EAF8;">
                          <h6 class="fw-semibold text-primary mb-2" style="color: #357ABD;">Why Use the Online Table?</h6>
                          <p>Filling out the table on the website gives you access to our <strong>ontology autocomplete</strong> feature, connected to the <em>OLS Ontology Lookup Service</em> for accurate and standardized ontology terms.</p>
                          <hr class="my-3" style="border-top: 1px dashed #D6EAF8;">
                          <h6 class="fw-semibold text-primary mb-2" style="color: #357ABD;">Hybrid Option</h6>
                          <p>You can also fill metadata for a few samples here, download the partially completed table, edit it locally, and upload it again when ready.</p>
                        </p>

                        <!--begin::Metadata AG Grid table container -->
                        <div class="metadata-table-container mb-4">
                          <!--begin::Metadata AG Grid table header-->
                          <div class="d-flex justify-content-end align-items-center mb-2">
                            <div class="me-2">
                              <button id="addColumnBtn" type="button" class="btn btn-outline-primary">
                                + Add Custom Column
                              </button>
                            </div>
                            <button id="addELBSBtn" type="button" class="btn btn-outline-primary">
                              + Add ELBS Report Criteria
                            </button>
                          </div>
                          <!--end::Metadata AG Grid table header-->

                          <!--begin::metadata AG Grid table-->
                          <div class="table-wrapper">
                            <table id="metadata-table" class="table table-hover align-middle shadow-sm">
                              <thead class="table-light sticky-top">
                                <tr>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Unique sample identifier">SAMPLE<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Unique identifier for the sample donor.">Subject ID<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Disease that the subject was diagnosed with at the time the sample was collected.">Disease<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Property to describe a cell type: a distinct morphological or functional form of cell.">Cell Type<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="The material entity (e.g. DNA) that is this sample. Use this property as tags that befit your sample, picking as many as needed. Choose the specific terms if possible (e.g. if the assayed molecule is cDNA, add 'cDNA' instead of just 'DNA').">Sample Type<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Property to describe any abnormal (i.e. deviation from normal or average) phenotype (i.e. detectable outward manifestations of a specific genotype).">Phenotypic Abnormality<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="The part of organism's anatomy or substance arising from an organism from which the biomaterial was derived, excluding cell type.">Material Anatomical Entity<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="An organismal quality inherent in a bearer by virtue of the bearer's physical expression of sexual characteristics.">Biological Sex<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Precise age of the individual at the time the sample was collected.">Age<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="This property describes the material entity the sample consists in. That is, an individual living system, such as animal, plant, bacteria or virus, that is capable of replicating or reproducing, growth and maintenance in the right environment.">Organism<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="when the sample was taken from the individual.">Sample Collection Date<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Specifies whether the sample is affected (case) or unaffected (control).">Case vs Control<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Describes the specific condition, treatment, or situation being investigated for the sample. The sample may or may not be affected by this condition under study, belonging to the case or control groups respectively.">Condition Under Study<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col">Is Deceased?</th>
                                  <th class="optional-col">Is Pregnant?</th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Indicates whether sepsis or a bacterial infection is suspected. If Yes, specify the strain involved.">Is Infection Suspected?<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Name of the suspected infection strain.">Infection Strain<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Specifies the hospital setting of the individual at the time of sample collection.">Hospitalization Status<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Extraction kit used.">Extraction Kit (DNA Isolation Method)<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Sample DNA amount.">DNA Mass<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col">DNA Mass Units</th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Volume of DNA carrying liquid (eg. 5mL urine)">Carrying Liquid Volume<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col">Carrying Liquid Volume Unit</th>
                                  <th class="optional-col">In vitro / In vivo</th>
                                  <th class="optional-col">Gel Electrophoresis Device</th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Medications the patient used.">Treatment<i class="bi bi-info-circle text-muted"></i></th>
                                  <th class="optional-col" data-bs-toggle="tooltip" title="Ethnicity of the subject.">Ethnicity<i class="bi bi-info-circle text-muted"></i></th>
                                  <th>Actions</th>
                                </tr>
                              </thead>

                              <tbody>
                                <tr class="metadata-row">
                                  <td>
                                    <span class="sample-display">Sample_1</span>
                                    <input type="hidden" name="sample_id[]" value="Sample_1">
                                  </td>
                                  <td><input type="text" name="subject_id[]" class="form-control form-control-sm" placeholder="Donor-10031"></td>
                                  <td>
                                    <div class="disease-wrapper">
                                      <div class="disease-field mb-2">
                                        <input type="text" name="disease[]" class="form-control form-control-sm ols-search" placeholder="Breast cancer">
                                      </div>
                                    </div>
                                  </td>
                                  <td>
                                    <div class="celltype-wrapper">
                                      <div class="celltype-field mb-2">
                                        <input type="text" name="celltype[]" class="form-control form-control-sm ols-search" placeholder="blood cell">
                                      </div>
                                    </div>
                                  </td>
                                  <td>
                                    <select name="sample_type[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>DNA</option>
                                      <option>RNA</option>
                                      <option>metabolite</option>
                                      <option>protein</option>
                                      <option>cDNA</option>
                                      <option>genomic DNA</option>
                                      <option>mitochondrial DNA</option>
                                      <option>messenger RNA</option>
                                      <option>ncRNA</option>
                                      <option>non polyA RNA</option>
                                      <option>long non polyA RNA</option>
                                      <option>nuclear RNA</option>
                                      <option>polyA RNA</option>
                                      <option>long polyA RNA</option>
                                      <option>snRNA</option>
                                      <option>total RNA</option>
                                      <option>cell culture</option>
                                      <option>biofilm</option>
                                      <option>tissue culture</option>
                                    </select>
                                  </td>
                                  <td>
                                    <div class="phenotype-wrapper">
                                      <div class="phenotype-field mb-2">
                                        <input type="text" name="phenotype[]" class="form-control form-control-sm ols-search" placeholder="Hearing abnormality">
                                      </div>
                                    </div>
                                  </td>

                                  <td>
                                    <input type="text" name="material[]" class="form-control form-control-sm ols-search" placeholder="Liver">
                                  </td>
                                  <td>
                                    <select name="sex[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>male</option>
                                      <option>female</option>
                                      <option>hermaphrodite</option>
                                      <option>pseudohermaphrodite</option>
                                      <option>unknown</option>
                                    </select>
                                  </td>
                                  <td><input type="number" name="age[]" class="form-control form-control-sm" placeholder="Enter years" step="0.01" min="0"></td>
                                  <td>
                                    <input type="text" name="organism[]" class="form-control form-control-sm ols-search" placeholder="Homo sapiens">
                                  </td>
                                  <td><input type="date" name="collection_date[]" class="form-control form-control-sm"></td>
                                  <td>
                                    <select name="case_control[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>case</option>
                                      <option>control</option>
                                      <option>not applicable</option>
                                    </select>
                                  </td>
                                  <td><input type="text" name="condition[]" class="form-control form-control-sm ols-search" placeholder="Insulin"></td>
                                  <td>
                                    <select name="is_deceased[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>Yes</option>
                                      <option>No</option>
                                    </select>
                                  </td>
                                  <td>
                                    <select name="is_pregnant[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>Yes</option>
                                      <option>No</option>
                                    </select>
                                  </td>
                                  <td>
                                    <select name="is_infection_suspected[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>Yes</option>
                                      <option>No</option>
                                    </select>
                                  </td>
                                  <td><input type="text" name="infection_strain[]" class="form-control form-control-sm ols-search" placeholder="Coronavirus red knot/p60/2006/GBR ()"></td>
                                  <td>
                                    <select name="hospitalization_status[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>Ambulant</option>
                                      <option>Hospitalized</option>
                                      <option>Emergency room</option>
                                      <option>Discharged</option>
                                      <option>Standard care unit</option>
                                      <option>Intensive care unit</option>
                                      <option>Operation room</option>
                                    </select>
                                  </td>
                                  <td>
                                    <select name="extraction_kit[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>Phenol-Chloroform</option>
                                      <option>Qiagen Virus/Pathogen Kit</option>
                                      <option>QIAamp Circulating Nucleic Acid Kit</option>
                                      <option>MacheryNagel Nucleospin Plasma XS</option>
                                      <option>MacheryNagel Gel and PCR Clean-up</option>
                                      <option>Epigentek FitAmp™ Circulating DNA Quantification Kit</option>
                                      <option>Analytik Jena, Polymer Mediated Enrichment (PME) free-circulating DNA Kit-ICP16</option>
                                      <option>Zymo ZR Serum DNA Kit</option>
                                      <option>Norgen Plasma/Serum Cell-Free Circulating DNA Purification Kit</option>
                                      <option>Perkin Elmer chemagic Circulating NA</option>
                                      <option>Roche cobas® DNA Sample Preparation kit</option>
                                      <option>BioChain cfPure Cell-Free DNA Extraction Kit</option>
                                      <option>Thermo Fisher Scientific MagMAX Cell-Free DNA Isolation Kit</option>
                                      <option>Roche MagNA Pure 24 System</option>
                                      <option>SanBio NEXTprep-Mag cfDNA Isolation Kit</option>
                                      <option>Westburg PME free-circulating DNA Extraction Kit</option>
                                      <option>Promega Maxwell RSC ccfDNA Plasma Kit</option>
                                      <option value="custom">Custom</option>
                                    </select>
                                  </td>
                                  <td ><input type="number" name="dna_mass[]" class="form-control form-control-sm" placeholder="Enter mass", step="0.01", min="0"></td>
                                  <td>
                                    <select name="dna_mass_units[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>pg</option>
                                      <option>ng</option>
                                      <option>µg</option>
                                    </select>
                                  </td>
                                  <td><input type="number" name="carrying_liquid_volume[]" class="form-control form-control-sm" placeholder="Enter volume" , step="0.01", min="0"></td>
                                  <td>
                                    <select name="carrying_liquid_volume_unit[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>µL</option>
                                      <option>mL</option>
                                      <option>L</option>
                                    </select>
                                  </td>
                                  <td>
                                    <select name="in_vitro_in_vivo[]" class="form-select form-select-sm">
                                      <option value="">Select</option>
                                      <option>In vitro</option>
                                      <option>In vivo</option>
                                    </select>
                                  </td>
                                  <td>
                                    <select name="device[]" class="form-select form-select-sm device-select">
                                      <option value="">Select</option>
                                      <option value="2100 Bioanalyzer Instrument, Agilent">2100 Bioanalyzer Instrument, Agilent</option>
                                      <option value="4150 TapeStation System, Agilent">4150 TapeStation System, Agilent</option>
                                      <option value="4200 TapeStation System, Agilent">4200 TapeStation System, Agilent</option>
                                      <option value="5200 Fragment Analyzer System, Agilent">5200 Fragment Analyzer System, Agilent</option>
                                      <option value="5300 Fragment Analyzer System, Agilent">5300 Fragment Analyzer System, Agilent</option>
                                      <option value="5400 Fragment Analyzer System, Agilent">5400 Fragment Analyzer System, Agilent</option>
                                      <option value="Qsep 1 Bio-Fragment Analyzer, Nippon">Qsep 1 Bio-Fragment Analyzer, Nippon</option>
                                      <option value="Qsep 100 Bio-Fragment Analyzer, Nippon">Qsep 100 Bio-Fragment Analyzer, Nippon</option>
                                      <option value="Qsep 400 Bio-Fragment Analyzer, Nippon">Qsep 400 Bio-Fragment Analyzer, Nippon</option>
                                      <option value="custom">Custom</option>
                                      </select>
                                  </td>
                                  <td>
                                    <div class="treatment-wrapper">
                                      <div class="treatment mb-2">
                                        <input type="text" name="treatment[]" class="form-control form-control-sm ols-search" placeholder="paracetamol">
                                      </div>
                                    </div>
                                  </td>
                                  <td>
                                    <input type="text" name="Ethnicity[]" class="form-control form-control-sm ols-search" placeholder="Ethnicity">
                                  </td>
                                  <td class="actions-cell text-center">
                                    <button type="button" class="btn btn-sm btn-outline-success add-row">+</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-row">−</button>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                          <!--end::metadata AG Grid table-->
                        </div>
                        <!--end::Metadata AG Grid table container -->
                        <div class="d-flex justify-content-between align-items-center mt-2">
                          <!-- Submit Table Button -->
                          <button id="submit-metadata-table" type="button" class="btn btn-success mb-3">
                            <i class="bi bi-check-circle me-2"></i> Confirm Table
                          </button>
                          <span id="download-csv" class="text-primary" style="cursor: pointer; font-size: 0.875rem;">
                            <i class="bi bi-download me-1"></i> Download CSV
                          </span>
                        </div>
                      </div>
                      <!--end::Option 1-->

                      <!--begin::Option 2 - Upload File-->
                      <div class="p-3 mb-3" 
                            style="background-color: #E7F4FB; border-left: 4px solid #4FA8E5; border-radius: 0.75rem;">
                        <div class="d-flex align-items-center mb-2">
                          <i class="bi bi-upload text-info me-2" style="font-size: 1.2rem;"></i>
                          <h6 class="fw-semibold mb-0" style="color: #2C5282;">Option 2: Upload Metadata File</h6>
                        </div>
                        <p class="mb-2">  
                          If you prefer, download our template file, fill it out, and upload it here.
                        </p>
                        <p class="text-muted mb-2">Accepted formats: CSV, TSV, TXT.</p>
                        <input type="file" name="meta_file" accept=".txt,.tsv,.csv" class="form-control form-control border rounded">
                      </div>
                      <!--end::Option 2-->

                      <!--begin::Choose Metadata to use for grouping analyses -->
                      <div class="mt-5 p-4 border rounded bg-white w-100">
                        <h4 class="mb-3">Group Analysis by Metadata</h4>
                        <p class="text-muted">
                          Select one or more metadata fields to group your results by.
                          <br>
                          <strong>Each selected metadata will trigger a separate analysis run.</strong>
                          <br>
                          For example, selecting <em>Disease</em> and <em>Biological Sex</em> will produce two full analyses —
                          one grouped by Disease and another grouped by Biological Sex.
                          <br>
                          <em>If no metadata is selected, no grouping will be applied.</em>
                        </p>

                        <div class="mt-3 mb-3">
                          <h6>Select metadata columns to group by:</h6>
                          <div class="row row-cols-1 row-cols-md-3 g-2 mt-2">
                            <!-- Column 1 -->
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Subject ID" id="group_subject_id">
                                <label class="form-check-label" for="group_subject_id">Subject ID</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Disease" id="group_disease">
                                <label class="form-check-label" for="group_disease">Disease</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Cell Type" id="group_cell_type">
                                <label class="form-check-label" for="group_cell_type">Cell Type</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Sample Type" id="group_sample_type">
                                <label class="form-check-label" for="group_sample_type">Sample Type</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Phenotypic Abnormality" id="group_phenotype">
                                <label class="form-check-label" for="group_phenotype">Phenotypic Abnormality</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Material Anatomical Entity" id="group_material">
                                <label class="form-check-label" for="group_material">Material Anatomical Entity</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Biological Sex" id="group_sex">
                                <label class="form-check-label" for="group_sex">Biological Sex</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Age" id="group_age">
                                <label class="form-check-label" for="group_age">Age</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Organism" id="group_organism">
                                <label class="form-check-label" for="group_organism">Organism</label>
                              </div>
                            </div>

                            <!-- Column 2 -->
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Case vs Control" id="group_casecontrol">
                                <label class="form-check-label" for="group_casecontrol">Case vs Control</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Condition Under Study" id="group_condition">
                                <label class="form-check-label" for="group_condition">Condition Under Study</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Is Deceased?" id="group_deceased">
                                <label class="form-check-label" for="group_deceased">Is Deceased?</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Is Pregnant?" id="group_pregnant">
                                <label class="form-check-label" for="group_pregnant">Is Pregnant?</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Is Infection Suspected?" id="group_infection">
                                <label class="form-check-label" for="group_infection">Is Infection Suspected?</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Infection Strain" id="group_infection_strain">
                                <label class="form-check-label" for="group_infection_strain">Infection Strain</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Hospitalization Status" id="group_hosp">
                                <label class="form-check-label" for="group_hosp">Hospitalization Status</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Extraction Kit (DNA Isolation Method)" id="group_extraction_kit">
                                <label class="form-check-label" for="group_extraction_kit">Extraction Kit</label>
                              </div>
                            </div>

                            <!-- Column 3 -->
                            <div class="col">
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="DNA Mass" id="group_dna_mass">
                                <label class="form-check-label" for="group_dna_mass">DNA Mass</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="DNA Mass Units" id="group_dna_mass_units">
                                <label class="form-check-label" for="group_dna_mass_units">DNA Mass Units</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Carrying Liquid Volume" id="group_carrying_liquid_volume">
                                <label class="form-check-label" for="group_carrying_liquid_volume">Carrying Liquid Volume</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Carrying Liquid Volume Unit" id="group_carrying_liquid_volume_unit">
                                <label class="form-check-label" for="group_carrying_liquid_volume_unit">Carrying Liquid Volume Unit</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="In vitro / In vivo" id="group_in_vitro_in_vivo">
                                <label class="form-check-label" for="group_in_vitro_in_vivo">In vitro / In vivo</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Gel Electrophoresis Device" id="group_device">
                                <label class="form-check-label" for="group_device">Gel Electrophoresis Device</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Treatment" id="group_treatment">
                                <label class="form-check-label" for="group_treatment">Treatment</label>
                              </div>
                              <div class="form-check">
                                <input class="form-check-input" name="metadata_group_columns_checkbox" type="checkbox" value="Ethnicity" id="group_ethnicity">
                                <label class="form-check-label" for="group_ethnicity">Ethnicity</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!--end::Choose Metadata to use for grouping analyses -->
                    </div>
                  </div>
                  <!--end::metadata -->
                  <style>
                    .metadata-table-container {
                      background: #fafafa;
                      border-radius: 12px;
                      padding: 1rem;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                    }
                    .table-wrapper {
                      overflow-x: auto;
                      border-radius: 10px;
                    }
                    #metadata-table {
                      border-collapse: separate;
                      border-spacing: 0;
                      width: 100%;
                      font-size: 0.9rem;
                    }
                    #metadata-table thead th {
                      position: sticky;
                      top: 0;
                      background: #f8f9fa;
                      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                      z-index: 2;
                    }
                    #metadata-table th, #metadata-table td {
                      min-width: 120px;
                      white-space: nowrap;
                      vertical-align: middle;
                    }
                    #metadata-table tbody tr:hover {
                      background-color: #f6faff;
                    }
                    .optional-col {
                      transition: all 0.3s ease;
                    }
                    .hidden-col {
                      display: none;
                    }
                    #metadata-table th {
                      position: relative;
                      user-select: none;
                    }
                    #metadata-table th .resizer {
                      position: absolute;
                      right: 0;
                      top: 0;
                      width: 6px;
                      cursor: col-resize;
                      user-select: none;
                      height: 100%;
                      z-index: 3;
                    }
                    #metadata-table th .resizer:hover {
                      background-color: rgba(0, 123, 255, 0.2);
                    }
                  </style>

                  <script>
                  // Enable column resizing
                  document.querySelectorAll("#metadata-table th").forEach(th => {
                    th.classList.add('resizable');
                    let startX, startWidth;
                    const resizer = document.createElement('div');
                    resizer.classList.add('resizer');
                    th.appendChild(resizer);

                    resizer.addEventListener('mousedown', e => {
                      startX = e.pageX;
                      startWidth = th.offsetWidth;
                      document.addEventListener('mousemove', resize);
                      document.addEventListener('mouseup', stopResize);
                    });
                    function resize(e) {
                      th.style.width = (startWidth + (e.pageX - startX)) + 'px';
                    }
                    function stopResize() {
                      document.removeEventListener('mousemove', resize);
                    }
                  });

                  document.addEventListener("DOMContentLoaded", () => {
                    const table = document.getElementById("metadata-table");
                    if (table) makeTableResizable(table);
                  });
                  </script>
                  <script>
                    document.addEventListener('DOMContentLoaded', function () {
                      const table = document.getElementById('metadata-table');
                      const tbody = table.querySelector('tbody');
                      // Apply initial gray colors on select/date
                      document.querySelectorAll('select.form-select').forEach(applySelectColor);
                      document.querySelectorAll('input[type="date"]').forEach(applyDateColor);

                      function renumberSamples() {
                      const sampleInputs = table.querySelectorAll('input[name="sample_id[]"]');
                      sampleInputs.forEach((input, index) => {
                        const number = index + 1; // start from 1
                        input.value = `Sample_${number}`;
                        const span = input.closest('td').querySelector('.sample-display');
                        if (span) {
                          span.textContent = `Sample_${number}`;
                        }
                      });
                    }
                    
                      function tryInitOls(root) {
                        if (typeof window.initOlsAutocomplete === 'function') {
                          try { window.initOlsAutocomplete(root); } catch(e){ console.warn('initOlsAutocomplete failed', e); }
                        }
                      }

                      // Click handler (add/remove)
                      table.addEventListener('click', function (e) {
                        const addBtn = e.target.closest('.add-row');
                        const removeBtn = e.target.closest('.remove-row');
                        if (addBtn) {
                          const currentRow = addBtn.closest('tr');
                          const newRow = currentRow.cloneNode(true);
                          const srcFields = currentRow.querySelectorAll('input, select, textarea');
                          const dstFields = newRow.querySelectorAll('input, select, textarea');
                          srcFields.forEach((src, i) => {
                            const dst = dstFields[i];
                            if (!dst) return;
                            if (dst.name === 'sample_id[]') {
                              dst.readOnly = true; // make it readonly so user cannot change
                            } else if (dst.tagName.toLowerCase() === 'select') {
                              dst.selectedIndex = src.selectedIndex;
                            } else {
                              dst.value = src.value;
                            }
                          });

                          // In new row apply color gray/black logic for select values
                          newRow.querySelectorAll('select.form-select').forEach(select => {
                            select.value = '';
                            applySelectColor(select);
                          });
                          // In new row apply color gray/black logic for date values
                          newRow.querySelectorAll('input[type="date"]').forEach(input => {
                            input.value = '';
                            applyDateColor(input);
                          });
        
                          const actionsCell = newRow.querySelector('.actions-cell');
                          if (actionsCell) {
                            actionsCell.innerHTML = '<button type="button" class="btn btn-sm btn-outline-primary add-row">+</button> ' +
                                                    '<button type="button" class="btn btn-sm btn-outline-danger remove-row">-</button>';
                          }

                          currentRow.after(newRow);
                          renumberSamples(); // update all sample numbers to not have wrong order of sampele_1, sample_3, sample_3
                          // reinitialize OLS autocomplete for all new .ols-search inputs in the new row
                          const newOlsInputs = newRow.querySelectorAll(".ols-search");
                          newOlsInputs.forEach(input => {
                            if (typeof window.initOlsAutocomplete === 'function') {
                              window.initOlsAutocomplete(input);
                            } else if (typeof initializeAutocomplete === 'function') {
                              initializeAutocomplete(input);
                            }
                          });
                          return;
                        }
                        if (removeBtn) {
                          const row = removeBtn.closest('tr');
                          if (!row) return;
                          if (tbody.querySelectorAll('tr').length > 1) {
                            row.remove();
                            renumberSamples(); // update all sample numbers after deletion
                          } else {
                            row.querySelectorAll('input, select, textarea').forEach(el => {
                              if (el.tagName.toLowerCase() === 'select') el.selectedIndex = 0;
                              else el.value = '';
                            });
                          }
                          return;
                        }
                      });
          
                       /**
                       * Convert metadata online table to csv
                       */
                      function tableToCSV(table) {
                          const tbody = table.querySelector('tbody');
                          const rows = Array.from(tbody.querySelectorAll('tr'));
                          if (rows.length === 0) return null;
                          const headers = Array.from(table.querySelectorAll('thead th'))
                                              .map(th => th.textContent.trim().replace(/,/g, ' '));
                          const csv = [headers.join(',')];
                          rows.forEach(row => {
                              const fields = Array.from(row.querySelectorAll('input, select, textarea'));
                              const values = fields.map(f => {
                                  let v = f.value || '';
                                  if (typeof v === 'string' && v.includes(',')) v = `"${v}"`; // escape commas
                                  return v;
                              });
                              csv.push(values.join(','));
                          });

                          return csv.join('\n');
                      }
                      /**
                       * If users clicks Submit metadata table, convert it to csv and add file to form data
                       */
                      document.getElementById('submit-metadata-table').addEventListener('click', function (e) {
                        e.preventDefault();
                        const table = document.getElementById('metadata-table');
                        const csv = tableToCSV(table);
                        if (!csv) { alert('No rows to submit'); return; }
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const form = document.getElementById('upload-form');
                        const fileInput = form.querySelector('input[name="meta_file"]');
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(new File([blob], 'meta_file.csv'));
                        fileInput.files = dataTransfer.files;
                        alert('Metadata table prepared. You can now click the main submit button to start the analysis.');
                       });

                      /**
                       * Download metdata table as csv button 
                       */
                      document.getElementById('download-csv').addEventListener('click', function () {
                        const table = document.getElementById('metadata-table');
                        const csv = tableToCSV(table);
                        if (!csv) { 
                          alert('No rows to export'); 
                          return; 
                        }
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'meta_file.csv';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                      });
                    });
                    
                  </script>

                  <script>
                    /**
                     * Handle adding custom columns button
                     */
                    document.getElementById('addColumnBtn').addEventListener('click', function () {
                      const columnName = prompt("Enter new column name:");
                      if (!columnName) return;
                      const table = document.getElementById('metadata-table');
                      const headerRow = table.querySelector('thead tr');
                      const newHeader = document.createElement('th');
                      newHeader.textContent = columnName;
                      headerRow.insertBefore(newHeader, headerRow.lastElementChild);
                      const rows = table.querySelectorAll('tbody tr');
                      rows.forEach(row => {
                        const newCell = document.createElement('td');
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.name = `custom_${columnName.toLowerCase().replace(/\s+/g, '_')}[]`;
                        input.className = 'form-control form-control-sm';
                        newCell.appendChild(input);
                        row.insertBefore(newCell, row.lastElementChild);
                      });
                    });

                    /*
                     * Load example data into the form without immidiate submission
                     */
                    document.getElementById('load-example').addEventListener('click', async () => {
                      const files = [
                          {url: './static/tests/electropherogram.csv', inputName: 'data_file'},
                          {url: './static/tests/metadata.csv', inputName: 'meta_file'}
                      ];
                      // Load electropherogram and metadata
                      for (const file of files) {
                          const response = await fetch(file.url);
                          const blob = await response.blob();
                          const fileObj = new File([blob], file.url.split('/').pop(), {type: blob.type});
                          const input = document.querySelector(`input[name="${file.inputName}"]`);
                          if (input) {
                              const dataTransfer = new DataTransfer();
                              dataTransfer.items.add(fileObj);
                              input.files = dataTransfer.files;
                          }
                      }
                      // Automatically select HSD5000 ladder option
                      const ladderOption = document.querySelector('input[name="ladder_file"][value="HSD5000"]');
                      if (ladderOption) {
                          ladderOption.checked = true;
                          const fileContainer = document.getElementById('fileUploadContainer');
                          if (fileContainer) fileContainer.style.display = 'none';
                      }
                      alert("Example data loaded! You can review or edit before submitting.");
                  });
                  </script>

                  <!-- ---------------------------------------------------------------------------------------- -->
                  <!-- SUBMISSION -->
                  <!-- ---------------------------------------------------------------------------------------- -->
                  <h3>Submit for Analysis</h3>
                  <p>
                    Your DNA file will be analysed for peaks, height normalized,
                    and grouped in case you provided metadata. Be patient, this may take a while.
                  </p>
                  <!-- Terms checkbox -->
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" value="" id="agree-terms">
                    <label class="form-check-label" for="agree-terms">
                      I have read and agree to the 
                      <a href="{{ url_for('legal_notice') }}" target="_blank">DNAvi Terms and Conditions</a>
                    </label>
                  </div>
                  <button type="submit" class="btn btn-success" id="submit-analysis-btn" >Submit</button>
                  <!-- ------------------------------------------------------------------------------ -->
                  <!--                            SAVE TO DB CONSENT                                  -->
                  <!-- ------------------------------------------------------------------------------ -->
                  <!--begin::Popup do you consent to save to db?-->
                  <div class="modal fade" id="saveConsent" tabindex="-1" aria-labelledby="saveConsentLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content rounded-3 shadow-lg">
                        <div class="modal-header bg-primary text-white">
                          <h5 class="modal-title" id="saveConsentLabel">Save Your Data?</h5>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <p class="mb-3">
                            Your analysis is ready to be submitted. Please choose how you would like DNAvi to handle your uploaded files and results:
                          </p>
                            <div class="list-group mb-3">
                              {% if user_logged_in %}
                                <div class="list-group-item">
                                  <span class="badge bg-success me-2">Analyze & Save</span>
                                  Your data will be securely stored in the DNAvi database. You can revisit and download your results anytime from your <em>Submissions Dashboard</em>.
                                </div>
                                <div class="list-group-item">
                                  <span class="badge bg-secondary me-2">Analyze Only</span>
                                  Your data will be processed now, but deleted after this session ends.
                                </div>
                                <div class="list-group-item text-muted">
                                  All saved data helps advance ongoing cell-free DNA research.
                                </div>
                              {% else %}
                                <div class="list-group-item">
                                  <span class="badge bg-success me-2">Analyze & Save</span>
                                  Your data will be securely stored in the DNAvi database to support future research.
                                </div>
                                <div class="list-group-item">
                                  <span class="badge bg-secondary me-2">Analyze Only</span>
                                  Your data will be processed once, then deleted after the session ends.
                                </div>
                              {% endif %}
                            </div>
                          <p class="text-muted small mb-0">
                            By choosing “Analyze & Save” you consent to securely store your data on the servers of the Hasso Plattner Institute in Potsdam, Germany.
                          </p>
                        </div>
                        <div class="modal-footer d-flex justify-content-between">
                          <button type="button" class="btn btn-outline-secondary btn-sm me-2 bg-secondary text-white" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">
                            Analyze Only
                          </button>
                          <button type="button" class="btn btn-success" id="confirm-save-btn">
                            Analyze & Save
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!--end::Popup do you consent to save to db?-->
              </form>
            </section>
        </div>

        <!--begin: Loading results -->
        <div id="loading-overlay">
          <div class="spinner"></div>
          <p>Preparing your results… please wait.</p>
        </div>
        <style>
          #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            text-align: center;
            padding-top: 20%;
            font-size: 1.5em;
            color: #007bff;
          }
          .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
          }
          @keyframes spin {100% {transform: rotate(360deg);}}
        </style>
        <!--end::Loading results-->
        <!--end::App Content-->
      </main>
      <!--end::App Main-->
      <!--begin::Footer-->
      <footer class="app-footer d-flex justify-content-between align-items-center px-3 py-2 border-top">
        <div>
            Copyright &copy; Anja Hess, Yara Matani, 2025.
        </div>
        <div>
            Design by &copy; 
            <a href="https://adminlte.io" class="text-decoration-none" target="_blank">AdminLTE.io</a>, 2014-2025.
        </div>
      </footer>
      <!--end::Footer-->
    </div>
    <!--end::App Wrapper-->
    <!--begin::Script-->
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <script
      src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"
      crossorigin="anonymous"
    ></script>
    <!--end::Third Party Plugin(OverlayScrollbars)--><!--begin::Required Plugin(popperjs for Bootstrap 5)-->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <!--end::Required Plugin(popperjs for Bootstrap 5)--><!--begin::Required Plugin(Bootstrap 5)-->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
    <!--end::Required Plugin(Bootstrap 5)--><!--begin::Required Plugin(AdminLTE)-->
    <script src="{{ url_for('static', filename='./js/adminlte.js') }}"></script>
    <!--end::Required Plugin(AdminLTE)--><!--begin::OverlayScrollbars Configure-->
    <script>
      const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
      const Default = {
        scrollbarTheme: 'os-theme-light',
        scrollbarAutoHide: 'leave',
        scrollbarClickScroll: true,
      };
      document.addEventListener('DOMContentLoaded', function () {
        const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);

        // Disable OverlayScrollbars on mobile devices to prevent touch interference
        const isMobile = window.innerWidth <= 992;

        if (
          sidebarWrapper &&
          OverlayScrollbarsGlobal?.OverlayScrollbars !== undefined &&
          !isMobile
        ) {
          OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
            scrollbars: {
              theme: Default.scrollbarTheme,
              autoHide: Default.scrollbarAutoHide,
              clickScroll: Default.scrollbarClickScroll,
            },
          });
        }
      });
    </script>
    <!--end::OverlayScrollbars Configure-->

    <!-- OPTIONAL SCRIPTS -->

    <!-- apexcharts -->
    <script
      src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"
      integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8="
      crossorigin="anonymous"
    ></script>
    <!--end::Script-->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        form.addEventListener("submit", function () {
          document.getElementById("loading-overlay").style.display = "block";
        });
      });
    </script>
    <!--begin::Metdata from OLS Autocomplete script-->
    <script src="{{ url_for('static', filename='./js/metadata_utils.js') }}"></script>
    <!--end::Metdata from OLS Autocomplete script-->
    <!--begin::database utils-->
    <script src="{{ url_for('static', filename='./js/database_utils.js') }}"></script>
    <!--end::database-->
  </body>
  <!--end::Body-->
</html>
