<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DNAvi | Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#007bff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">

  <!-- Fonts -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" media="print" onload="this.media='all'">

  <!-- Plugins -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/adminlte.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css">
</head>
<body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">

<div class="app-wrapper">
  <!-- Header -->
  <nav class="app-header navbar navbar-expand bg-body">
    <div class="container-fluid">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button"><i class="bi bi-list"></i></a>
        </li>
        <li class="nav-item"><a class="nav-link active" href="{{url_for('home')}}">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="{{url_for('citation')}}">About</a></li>
        <li class="nav-item"><a class="nav-link" href="{{url_for('documentation')}}">Documentation</a></li>
        <li class="nav-item"><a class="nav-link" href="{{url_for('contact')}}">Contact</a></li>
        <li class="nav-item"><a class="nav-link" href="{{url_for('legal_notice')}}">Impressum | Legal notice</a></li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <!--begin::Navbar Login/logout-->
        <li class="nav-item">
          {% if current_user.is_authenticated %}
            <li class="nav-item">
              <span class="nav-link">Hello, {{current_user.id}}</span>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{url_for('logout')}}">Logout</a>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="nav-link" href="{{url_for('login')}}">Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{url_for('register')}}">Register</a>
            </li>
          {% endif %}
          <li class="nav-item">
            <a class="nav-link" href="{{url_for('submissions_dashboard')}}">My submissions</a>
          </li>
        </li>
        <!--end::Navbar Login/logout-->
        <li class="nav-item">
          <a class="nav-link" href="#" data-lte-toggle="fullscreen">
            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
          </a>
        </li>
      </ul>
    </div>
  </nav>

    <!-- Main Content -->
  <main class="app-main">
    <div class="app-content content">
      <div class="content-wrapper">
        <!-- Content Header -->
          <div class="app-content-header">
            <!--begin::Row-->
            <div class="row">
              <div class="row align-items-center">
                <div class="col-sm-6">
                  <h3 class="mb-0">Results</h3>
                </div>
              </div>
            </div>
            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>

        <!-- Content Body -->
        <div class="content-body container-fluid">
          <!-- Results Intro Section -->
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center">
              <div>
                <p class="text-muted mb-0">
                  View your analysis interactively in this web interface.  
                  For a more detailed analysis download the ZIP file.
                </p>
              </div>
              <div class="mt-3 mt-md-0">
                <a href="{{url_for('download', submission_id=output_id)}}" class="btn btn-success btn">
                  <i class="bi bi-download me-2"></i> Download All as ZIP
                </a>
              </div>
            </div>
          </div>

          <!-- begin:: overview -->
          <h3 class="mb-3">Overview</h3>
          <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            <div class="col">
              <a href="#sec-elbs" class="text-decoration-none overview-link">
                <div class="card shadow-sm h-100 hover-scale">
                  <div class="card-body d-flex align-items-center">
                    <i class="bi bi-file-earmark-text me-3 fs-3 text-primary"></i>
                    <span class="fw-semibold">ELBS Report</span>
                  </div>
                </div>
              </a>
            </div>
            <div class="col">
              <a href="#sec-line" class="text-decoration-none overview-link">
                <div class="card shadow-sm h-100 hover-scale">
                  <div class="card-body d-flex align-items-center">
                    <i class="bi bi-graph-up me-3 fs-3 text-success"></i>
                    <span class="fw-semibold">Line Plots</span>
                  </div>
                </div>
              </a>
            </div>
            <div class="col">
              <a href="#sec-bar" class="text-decoration-none overview-link">
                <div class="card shadow-sm h-100 hover-scale">
                  <div class="card-body d-flex align-items-center">
                    <i class="bi bi-bar-chart me-3 fs-3 text-warning"></i>
                    <span class="fw-semibold">Bar Plots</span>
                  </div>
                </div>
              </a>
            </div>
            <div class="col">
              <a href="#sec-violin" class="text-decoration-none overview-link">
                <div class="card shadow-sm h-100 hover-scale">
                  <div class="card-body d-flex align-items-center">
                    <img src="{{url_for('static', filename='img/violin_plot.svg')}}" 
                        alt="Violin Plot" class="me-3" style="width:24px; height:24px;">
                    <span class="fw-semibold">Violin Plots</span>
                  </div>
                </div>
              </a>
            </div>
            <div class="col">
              <a href="#sec-cluster" class="text-decoration-none overview-link">
                <div class="card shadow-sm h-100 hover-scale">
                  <div class="card-body d-flex align-items-center">
                    <i class="bi bi-diagram-3 me-3 fs-3 text-secondary"></i>
                    <span class="fw-semibold">Cluster Maps</span>
                  </div>
                </div>
              </a>
            </div>
            <div class="col">
              <a href="#sec-statistics" class="text-decoration-none overview-link">
                <div class="card shadow-sm h-100 hover-scale">
                  <div class="card-body d-flex align-items-center">
                    <i class="bi bi-table me-3 fs-3 text-dark"></i>
                    <span class="fw-semibold">Statistics</span>
                  </div>
                </div>
              </a>
            </div>
          </div>
          <!-- end:: overview -->

          <!-- begin: results -->
          <div class="accordion mt-4" id="resultsAccordion">

            <!--begin:: ELBS report -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-elbs">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec-elbs">
                  ELBS Report
                </button>
              </h2>
              <div id="sec-elbs" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                <div class="accordion-body text-center">
                  {% for f in pdf_files %}
                    {% if "dnavireport" in f.lower() %}
                      <embed src="{{url_for('serve_result_file', output_id=output_id, filename=f)}}"
                            type="application/pdf"
                            style="width:90%; height:600px;">
                      <a class="btn btn-primary mt-3" target="_blank"
                        href="{{url_for('serve_result_file', output_id=output_id, filename=f)}}">
                        Open PDF
                      </a>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
            <!--end:: ELBS report -->

            <!--begin:: line plots -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-line">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#sec-line">
                  Line Plots
                </button>
              </h2>
              <div id="sec-line" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                <div class="accordion-body">
                  {% set line_patterns = ["peaks_", "0_interpolated", "all_samples", "all_samples_summary", "all_samples_by"] %}
                  {% for f in peaks_files + other_files %}
                    {% set fname = f.lower() %}
                    {% if line_patterns | select('in', fname) | list | length > 0 %}
                      <div class="text-center mb-4">
                        <a href="{{url_for('serve_result_file', output_id=output_id,
                                            filename=f.replace('.png','.pdf'))}}"
                          target="_blank">
                          <img src="{{url_for('serve_result_file', output_id=output_id, filename=f)}}"
                              alt="line plot"
                              style="max-width:100%; border:1px solid #ccc; border-radius:4px; padding:4px;">
                        </a>
                        <div class="text-muted small mt-1">{{f}}</div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
            <!--end:: line plots -->

            <!--begin:: bar plots -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-bar">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec-bar">
                  Bar Plots
                </button>
              </h2>
              <div id="sec-bar" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                <div class="accordion-body">
                  {% for f in other_files %}
                    {% if "peak_statistics_sample" in f %}
                      <div class="text-center mb-4">
                        <img src="{{url_for('serve_result_file', output_id=output_id, filename=f)}}"
                            alt="bar plot"
                            style="max-width:100%; border:1px solid #ccc; border-radius:4px; padding:4px;">
                        <div class="text-muted small mt-1">{{f}}</div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
            <!--end:: bar plots -->

            <!--begin:: violin plots -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-violin">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec-violin">
                  Violin Plots
                </button>
              </h2>
              <div id="sec-violin" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                <div class="accordion-body">
                  {% for f in other_files %}
                    {% if "peak_statistics" in f.lower() and "peak_statistics_sample" not in f %}
                      <div class="text-center mb-4">
                        <img src="{{url_for('serve_result_file', output_id=output_id, filename=f)}}"
                            alt="violin plot"
                            style="max-width:100%; border:1px solid #ccc; border-radius:4px; padding:4px;">
                        <div class="text-muted small mt-1">{{f}}</div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
            <!--end:: violin plots -->

            <!--begin:: cluster maps -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-cluster">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec-cluster">
                  Cluster Maps
                </button>
              </h2>
              <div id="sec-cluster" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                <div class="accordion-body">
                  {% for f in other_files %}
                    {% if "cluster" in f.lower() %}
                      <div class="text-center mb-4">
                        <img src="{{url_for('serve_result_file', output_id=output_id, filename=f)}}"
                            alt="cluster map"
                            style="max-width:100%; border:1px solid #ccc; border-radius:4px; padding:4px;">
                        <div class="text-muted small mt-1">{{f}}</div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>

            <!--begin:: statistics-->
            <div class="accordion-item">
              <h2 class="accordion-header" id="heading-stat">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sec-statistics">
                  Statistics
                </button>
              </h2>
              <div id="sec-statistics" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
                <div class="accordion-body">
                  {% for t in statistics_files %}
                  <section class="mb-4">
                    <div class="card card-outline card-primary shadow-sm">
                      <div class="card-header">
                        <h5 class="card-title mb-0">{{t.name}}</h5>
                      </div>
                      <div class="card-body table-responsive p-0">
                        <table class="table table-striped table-hover mb-0">
                          <thead class="table-primary">
                            <tr>
                              {% for col in t.columns %}
                              <th>{{col}}</th>
                              {% endfor %}
                            </tr>
                          </thead>
                          <tbody>
                            {% for row in t.preview %}
                            <tr>
                              {% for col in t.columns %}
                              <td>{{row[col]}}</td>
                              {% endfor %}
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                        <div class="p-2 text-end">
                          <small>
                            This is a preview
                            <a href="{{url_for('serve_result_file', output_id=output_id, filename=t.name)}}" target="_blank">
                              download full CSV here
                            </a>
                          </small>
                        </div>

                      </div>
                    </div>
                  </section>
                  {% endfor %}
                </div>
              </div>
            </div>
            <!--end:: statistics-->
          </div>
          <!--end:: results-->
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="app-footer d-flex justify-content-between align-items-center px-3 py-2 border-top">
    <div>&copy; Anja Hess, Yara Matani, 2025. License: GPL-3.0. </div>
    <div>Design by &copy; <a href="https://adminlte.io" target="_blank" class="text-decoration-none">AdminLTE.io</a>, 2014-2025.</div>
  </footer>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"></script>
<script src="{{url_for('static', filename='js/adminlte.js')}}"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"></script>
<script>
const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
const Default = {scrollbarTheme:'os-theme-light', scrollbarAutoHide:'leave', scrollbarClickScroll:true};
document.addEventListener('DOMContentLoaded', function(){
  const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
  const isMobile = window.innerWidth <= 992;
  if(sidebarWrapper && OverlayScrollbarsGlobal?.OverlayScrollbars !== undefined && !isMobile){
    OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
      scrollbars:{
        theme:Default.scrollbarTheme,
        autoHide:Default.scrollbarAutoHide,
        clickScroll:Default.scrollbarClickScroll
      }
    });
  }
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const frames = document.querySelectorAll('.peak-frame');
    if (frames.length === 0) return;

    let current = 0;

    const showFrame = (index) => {
      frames.forEach((f, i) => f.style.display = i === index ? 'block' : 'none');
    };

    document.getElementById('prevPeak').addEventListener('click', () => {
      current = (current - 1 + frames.length) % frames.length;
      showFrame(current);
    });

    document.getElementById('nextPeak').addEventListener('click', () => {
      current = (current + 1) % frames.length;
      showFrame(current);
    });
  });

/*
 * Handle overview clicks to expand the clicked section
*/
document.addEventListener('DOMContentLoaded', function() {
  const overviewLinks = document.querySelectorAll('.overview-link');
  overviewLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const targetCollapse = document.getElementById(targetId);
      if (targetCollapse) {
        const bsCollapse = new bootstrap.Collapse(targetCollapse, {toggle: true});
        targetCollapse.scrollIntoView({behavior: 'smooth', block: 'start'});
      }
    });
  });
});
</script>

</body>
</html>
